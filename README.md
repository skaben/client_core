# **SKABEN smart client core**

Ядро для умного клиента SKABEN cодержит базовую структуру клиентского устройства для взаимодействия с сервером SKABEN.

Все устройства на базе OrangePI должны использовать это ядро.

##### Инициализация приложения описана в `main.py`

Необходимые условия:

- должен присутствовать экземпляр системной конфигурации [SystemConfig](#config-component)
- должен присутствовать экземпляр конечного устройства [Device](#device-component)

в процессе запуска происходит создание обработчика событий очередей EventRouter, который на основании содержимого сообщений обрабатывает их в [Контекстах](#contexts-component)

# Список компонентов приложения

## Device Component 

`device.py` cодержит базовый класс устройства.
В любых новых устройствах на основе данного ядра должно быть обеспечено наследование от класса `BaseDevice`

- `.run` 
- `.state_update`

## Config Component

`config.py` 

Классы конфигурации системы.
Данные храним в .yml файлах.

#### `BaseConfig`

- `.not_stored_keys` - применяется для создания фильтра в `.update()`
- `.minimal_essential_conf` - минимально необходимые параметры для старта работы устройства

#### `SystemConfig`

Базовый класс конфигурации приложения, остается неизменным на протяжении работы приложения.

Задачи: назначение UID, ip, настройка логирования, создание внутренней и внешней очереди событий.

- `q_int` - очередь внутренними событиями между компонентами
- `q_ext` - очередь сообщений к серверу

сюда же входят параметры `dev_type`, `uid`, `broker_ip`, `iface`

Файл: по умолчанию `./conf/system_config.yml` создается из `./templates/system_config.yml.template` при развертывании приложения (скрипт `deploy.sh`) 

#### `DeviceConfig`

Базовый класс конфигурации устройства, изменяется в зависимости от игровых событий.

Задачи: обновление локального списка параметров конфигурации устройства, создание файла с минимальной конфигурацией по умолчанию из шаблона.

Файл: по умолчанию `./conf/device_config.yml` создается из содержимого `minimal_essential_conf` при запуске приложения

## Contexts Component

`contexts.py`

Обработчики событий внутренней очереди.\
Расширяют функционал `main.EventRouter`

#### `EventContext`  

Основной контекст - управляет состоянием устройства.\
Обрабатывает события пользовательского ввода и сообщения от сервера.\
Подтверждает результат обновления состояния устройства (`ACK/NACK` пакет)

#### `MQTTContext`

Обрабатывает расшифрованные пакеты от MQTT клиента,
обновляет keep-alive timestamp устройства (файл `ts`), отвечает на пинги, перенаправляет события об операциях с текущим состоянием устройства в основной контекст. 